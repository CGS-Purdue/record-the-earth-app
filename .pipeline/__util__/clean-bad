#!/bin/bash

# - dont actually run this
exit 0


# ANDROID-BUILD
# -------------
# BUILD THE ANDROID PROJECT FROM THE ./android directory
# Script Origin: https://github.com/infinitered/ignite
# Config: settings.gradle
# Outputs: bundle.jar


# **THIS SCRIPT IS VERY WRECKLESS**

#         | WHAT WILL BE RM -RF IF THIS WERE ACCIDENTALLY UNSET
#         V
rm -rf $TMPDIR/react-*

watchman watch-del-all

rm -rf ios/build

rm -rf node_modules/

npm cache clean --force

npm i

# YOU SHOULD NORMALLY NOT NEED REMOVE AUTOMATE FILES/FOLDER REMOVAL WITH A SCRIPT
# BUT IF YOU DO, BE ESPECIALLY CAREFUL IF THEOSE SCRIPTS ACCEPT VARIABLES AS INPUT
# ---

# AN EQUAL SOLUTION BUT ONE THAT IS MUCH SAFER WOULD INVOLVE MOVING THE
# UNWANTED FOLDERS TO A TEMPORARY LOCATION AND THEN RESTRICT YOUR FUNCTIONS
# TO ONLY OPERATE WITHIN THAT SANDBOXED PATH, ALLOW YOUR SCRIPT
# THIS IS SIMILAR TO HOW YOU COULD USE A CHROOTS TO PERFORM RISKY OPERATIONS
# TO PREVENT THEM FROM ACCIDENTALLY DELETING YORU PROJET OR  YOUR ENTIRE SERVER.

# OFTEN YOU MANY PEOPLE THAT REGULARLY WRITE SCRIPTS LIKE THIS
# ALSO OVER USING THE SUDO <THIS> COMMAND WHICH CAN BE A BAD COMBINATION IF YOU HAVE
# EVER MADE A MISTAKE OR TYPO BEFORE.
# AT THE FIRST SIGN SOMETHING DIDNT' WORK. THE ABOVE PATTERN IS SETTINGS YOURSELF UP
# UNHAPPY SITUATION.

# OR HOW ABOUT IF $TEMPDIR HAS A SPACE IN THE MIDDLE BECAUSE SOMEONE WANTS TO USE
# WINDOWS FOR "PHOTOSHOP". .. YOU'RE SCREWED, SOMETHIGN IS GETTING DELETED. HOPEFULLY
# ITS SOMETHING YOU DON'T HAVE READ/WRITE ACCESS TO.
# ---
# A SECONDARY NOTE IS THAT WE DON'T REALLY NEED TO WIPE TEH ENTIRE node_modules DIRECTORY
# AND REINSTALL AS OFTEN ENOUGH THAT IT WOULD BE USEFUL IN A SCRIPT.
# NODE MODULES FOLDER IS SOMETIMES HUGE AND HAS PRE AND POST HOOKS, LINT CHECKS AND OFTEN
# BUILDS GIANT PROGRAMS FROM SOURCE LIKE ELECTRON OR THE CHROME ENGINE.

# IF YOURE DOING THIS BECEUASE YOU THNK IT SOLVES A PROBLEM YOU'RE HAVING THEM MOST LIKELY
# THERE IS SOMETHING INCORRECT IN YORU USER CONFIGURATION THAT WOULD LET YOU NOT HAVE TO
# DO THIS UNLESS THERE WAS A GOOD REASON, LIKE MAJOR VERSION UPDATES OR MIGRATING TO A NEW
# FRAMEWORK.

## IF YOU READ THROUGH THE NPM DOCUMENTATION THEY STATE THAT CLEARING THE CACHE
# IS NOT RECOMENDED AND ALTHOGUH I DONT THINK THERES SPECIFIC COMMENTS ABOUT WIPING THE WHOLE FOLDER,
# I AM VERY CERTAIN THERE IS NO CLEAR BENEFITS OR GOOD REASON TO DO THIS EVEN IF IT AT WORST HAS
# NO EFFECT AT ALL.


# A SLIGHTLY SAFTER / MORE MORE GENERAL VERSION OF A CLEAN SCRIPT IS BELOW.
# THIS IS VERY SIMILAR TO ONE I ACTUALLY USED BEFORE CLEAR OUT BUILD FILES ON
# A LIVE DEVELOPMENT SERVER EACH TIME I PUSHED TO GIT.

BASE_DIR="$(npm prefix)"
IOS_DIR=ios
IOS_BUILD_DIR=build
NPM_MODULE_DIR=node_modules
REACT_MODULES_PATTERN=/react-*
REACT_TEMP_DIR="$TMPDIR"
TIMESTAMP="$(date +'%y%m%d.%H%M%S')"

REACT_MODULES_PATH="$BASE_DIR/${REACT_TEMP_DIR}/${REACT_MODULES_PATTERN}"
NPM_MODULE_PATH="${BASE_DIR}/${NPM_MODULE_DIR}"
IOS_BUILD_PATH="$BASE_DIR/${IOS_DIR}/${IOS_BUILD_DIR}"

# WE SHOULD HAVE STARTED HERE BUT THIS IS JUST TO MAKE SURE AND FOLLOW SOME LOGICAL STEPS

cd ${BASE_DIR}

[[ ! -d "${BASE_DIR}/.removed/" ]] && mkdir "${BASE_DIR}/.removed/"


mkdir "./.removed/${TIMESTAMP}"

[[ -d "$REACT_MODULES_PATH" ]] && mv "${REACT_MODULES_PATH}"  "./.removed/${TIMESTAMP}/"
[[ -d "$NPM_MODULE_PATH" ]] && mv "${NPM_MODULE_PATH}"  "./.removed/${TIMESTAMP}/"
[[ -d "$IOS_BUILD_PATH" ]] && mv "${IOS_BUILD_PATH}"  "./.removed/${TIMESTAMP}/"


cd .removed

rm --one-file-system --preserve-root -rf "./${TIMESTAMP}"

npm audit

npm outdated

echo "Done."
