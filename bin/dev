#!/bin/bash

# EXPO HELPER
# -------------
# device reverse tunnel        exp://127.0.0.1:19000
# Metro Bundler on                        port 19001
# Expo DevTools is            http://localhost:19002
# RCT_METRO_PORTL                             :8081
# The debugger will receive a list of all project roots, separated by a space. For example, if you set
# REACT_DEBUGGER="node /path/to/launchDebugger.js --port 2345 --type ReactNative",
# node /path/to/launchDebugger.js --port 2345 --type ReactNative /path/to/reactNative/app
# --redirect-warnings=...                   write warnings to file instead of stderr
# --title=...                               the process title to use on startup
# --require=...                             module to preload (option can be repeated)
# --inspect[=[host:]port]                   activate inspector on host:port (default: 127.0.0.1:9229)
# --inspect-brk[=[host:]port]               activate inspector on host:port and break at start of user script
# --debug-port, --inspect-port=[host:]port  set host:port for inspector
# -                                         script read from stdin (default if no file name is provided, interactive mode if a tty)
# --                                        indicate the end of node options
BASE_DIR="$(npm prefix)"
APP_DIR="/data/apps"
ABD_PATH="${ANDROID_HOME}/platform-tools"
ANDROID_SERIAL="025abd11727717ac"
APP_DEBUG_APPDATA="yes"
DEBUG_LOGGING="yes"
DEV_ENV="expo"
EXPO_DEBUG="true"
NODE_DEBUG='react-native,react,expo'
NODE_ENV="development"
NODE_OPTIONS="--require=./preload_modules/test"
NODE_PATH="$NODE_PATH:preload_modules:node_modules"
REACT_DEBUGGER="/data/library/React_Library/react-native-debugger/npm-package/bin/rndebugger-open --expo --open"
REACT_EDITOR="atom"
# __REACT_DEVTOOLS_PORT__
# __DEV__

export REACT_DEBUGGER

[[ -f .npmrc ]] && source .npmrc
[[ -f .env ]] && source .env

echo "Checking Android path ..."
[[ -z $ANDROID_HOME ]] && echo 'ANDROID_HOME is not set. Skipping command' && exit 0

echo "Settings up additional devtools..."
# REACTOTRON
[[ ! -z $RUN_REACTOTRON ]] \
    &&  $ANDROID_HOME/platform-tools/adb reverse tcp:9090 tcp:9090 \
    && ${APP_DIR}/reactotron/Reactotron.2.17.0.AppImage &

# REACT DEVTOOLS
[[ ! -z $RUN_REACT_DEVTOOLS ]] \
    && $ANDROID_HOME/platform-tools/adb reverse tcp:8097 tcp:8097 \
    && npm run react-devtools &

echo "
  NODE_ENV  ${NODE_ENV}
  NODE_PATH $NODE_PATH
  NODE_OPTIONS  ${NODE_OPTIONS}
  NODE_DEBUG  ${NODE_DEBUG}
  DEV_ENV  ${DEV_ENV}
  EXPO_DEBUG  ${EXPO_DEBUG}
  REACT_DEBUGGER=${REACT_DEBUGGER}
  DEBUG_LOGGING  ${DEBUG_LOGGING}
  APP_DEBUG_APPDATA  ${APP_DEBUG_APPDATA}
  REACT_EDITOR  ${REACT_EDITOR}
"

NODE_PATH="${NODE_PATH}" \
NODE_ENV="${NODE_ENV}" \
NODE_OPTIONS="${NODE_OPTIONS}" \
NODE_DEBUG="${NODE_DEBUG}" \
DEV_ENV="${DEV_ENV}" \
REACT_DEBUGGER=${REACT_DEBUGGER} \
APP_DEBUG_APPDATA="${APP_DEBUG_APPDATA}" \
REACT_EDITOR="${REACT_EDITOR}" \
REACT_DEBUGGER="${REACT_DEBUGGER}" \
EXPO_DEBUG="${EXPO_DEBUG}" \
DEBUG_LOGGING="${DEBUG_LOGGING}" \
  node ${BASE_DIR}/node_modules/.bin/expo start \
    --clear \
    --max-workers 5 \
    --no-minify \
    --no-https \
    --dev \
    --host localhost \
    --android
